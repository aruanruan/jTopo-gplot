<!DOCTYPE html>
<html lang="en">
    <meta charset="UTF-8">
    <title>the test for network topology</title>
    <style type="text/css">
        html, body{
            font:14px/1.8 Arial,Microsoft YaHei,黑体,宋体,sans-serif;
            height:100%;
        }
        *{
            margin:0;
            padding:0;
        }
        /*纯右键菜单*/
        #contextmenu {
            width:122px;
            border: 1px solid #aaa;
            border-radius:7px;
            border-bottom: 0;
            background: #eee;
            position: absolute;
            list-style: none;
            margin: 0;
            padding: 0;
            display: none;
            box-shadow: 0 0 5px #434343;
        }
        #contextmenu li{
            width:122px;
            position:relative;
        }

        #contextmenu li a {
            height:30px;
            line-height: 30px;
            width:100px;
            margin-left: 11px;
            text-align: center;
            display: block;
            border-bottom: 1px solid #aaa;
            cursor: pointer;

        }

        #contextmenu>li:hover {
            background: #fff;
            border-radius:7px;
        }
        #linkmenu {
            width:122px;
            border: 1px solid #aaa;
            border-radius:7px;
            border-bottom: 0;
            background: #eee;
            position: absolute;
            list-style: none;
            margin: 0;
            padding: 0;
            display: none;
            box-shadow: 0 0 5px #434343;
        }
        #linkmenu li {
            width:122px;
        }
        #linkmenu li a {
            width:100px;
            height:30px;
            line-height: 30px;
            display: block;
            border-bottom: 1px solid #aaa;
            cursor: pointer;
            margin-left: 11px;
            text-align: center;
        }

        #linkmenu li:hover {
            background: #fff;
            border-radius:7px;
        }
        /*button*/
        .jtopo_toolbar{
            height:30px;
        }
        input[type="button"]{
            display: inline-block;
            outline: none;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            font: 10px/100% Arial, Helvetica, sans-serif;
            padding: .5em 1em .55em;
            -webkit-border-radius: .3em; 
            -moz-border-radius: .3em;
            border-radius: .3em;
            color: #2E2C2C;
            border: solid 1px #D6D4D4;
            background: #E4E0E0;
        }
        input[type="button"]:hover{
            background: #CECDCD;
            border: solid 1px #CECDCD;
        }
    </style>
<body>
    <div id="content">
        <canvas id="canvas">sorry,your browser do not support canvas label</canvas>
    </div>

<ul id="contextmenu" style="display:none;">
    <li><a>监视</a></li>
    <li><a>完成</a></li>
    <li><a>添加连线</a></li>
    <li><a>放大</a></li>
    <li><a>缩小</a></li>
    <li><a>取消</a></li>
</ul>
<ul id="linkmenu" style="display:none;">
    <li><a>删除连线</a></li>
    <li><a>取消</a></li>
</ul>
<script src="js/jquery.min.js" type="text/javascript"></script>
<script src="js/jtopo-0.4.8-min.js" type="text/javascript"></script>
<script type="text/javascript">
        $(document).ready(function() {

            var canvas = document.getElementById('canvas');
            canvas.height = window.innerHeight * 0.895;
            canvas.width = window.innerWidth;

            var scene = new JTopo.Scene();
            scene.background = './img/bg.png';
            var stage = new JTopo.Stage(canvas);
            showJTopoToobar(stage);
            var currentNode = null;
            var endNode = null;
            var tmpx = null;
            var tmpy = null;
            var validation = null;
            var serialNumber = null;
            var con = [];
            var server = [];
            var server_datail = [];

            //服务器载入绘制拓扑图
            $.ajax({
                typt:"GET",
                url:"js/jsonst.json",
                dataType:"json",
                success:function(data){
                        data.forEach(function(a){
                    if(a.elementType == "container"){
                        if(a.type == "A"){
                            AddContainer(a.x, a.y, a.text,a.font,a.serialNumber,a.type);      
                        }else if(a.type == "B"){
                            AddCabinet(a.x,a.y,a.text,a.serialNumber,a.type,a.relate);
                        }
                    }
                    });
                        data.forEach(function(a){
                    if(a.elementType == "node"){
                        if(a.type == "D"){
                            AddNode(a.x, a.y, a.text, a.Image, a.textPosition,a.serialNum,a.type,a.relate);      
                        }else if(a.type == "C"){
                            AddEquipment(a.text, a.Image, a.textPosition,a.serialNum,a.type);
                        }
                    }
                    });

                         data.forEach(function(a){
                    if(a.elementType == "link"){
                        var nodeA = scene.findElements(function(e){return e.id == a.nodeAid;});
                        var nodeZ = scene.findElements(function(e){return e.id == a.nodeZid;});
                        if(nodeA[0] && nodeZ[0]) {
                            Addlink(nodeA[0], nodeZ[0], a.text, a.fontColor);
                        }
                    }
                    });
                }
                });
            //画出拓扑图(函数)
            function AddContainer(x, y,str,font,serialNumber,type){//机房
                var container = new JTopo.Container(str);
                container.layout = JTopo.layout.TreeLayout('down');
                container.serializedProperties.push('type');
                container.serializedProperties.push('serialNumber');//保存当前容器所在的数组序列号
                container.textPosition = 'Bottom_Center';
                container.width = 400;
                container.height = 400; 
                container.fillColor = '7, 6, 6';
                container.borderRadius = 15; // 边框
                container.borderColor = '1,1,1,1';
                container.borderWidth = 2;
                container.shadow = true;//阴影
                container.shadowOffsetX = "1";
                container.shadowOffsetY = "1";
                container.alpha = 0.1;
                container.zIndex = 3;
                container.x = x;
                container.y = y;
                //节点形式加入背景图片
                var node1 = new JTopo.Node();
                node1.zIndex = 1;
                node1.setImage('./img/room.gif', true);
                node1.setLocation(x,y);
                node1.dragable = false;
                node1.showSelected = false;
                node1.selected = false;
                //加入背景字
                var node2 = new JTopo.TextNode(str);
                node2.font = 'bold 16px 微软雅黑';
                node2.setLocation(x+175, y+380);
                node2.zIndex = 2;
                node2.shadow = true;
                scene.add(node1);
                scene.add(node2);
                container.add(node1);
                container.add(node2);
                scene.add(container);
                con[serialNumber] = container; 
                container.serialNumber = serialNumber;
                container.type = type;
                return container;
            }

            function AddCabinet(x,y,str,serialNumber,type,relate){//机柜详情
                var container = new JTopo.Container(str);
                container.layout = JTopo.layout.FlowLayout(5,5);
                container.serializedProperties.push('type');
                container.serializedProperties.push('serialNumber');
                container.serializedProperties.push('relate');
                container.textPosition = 'Middle_Center';
                container.width = 200;
                container.height = 400;
                container.fontColor = '100,255,0';//颜色
                container.font = '14pt 微软雅黑';
                container.fillColor = '7, 6, 6';
                container.borderRadius = 10; // 边框
                container.borderColor = '20,20,20,1';
                container.borderWidth = 1;
                container.shadow = true;//阴影
                container.shadowOffsetX = "";
                container.shadowOffsetX = "";
                container.alpha = 0.5;
                container.zIndex = 20;
                container.x = x;
                container.y = y;
                //背景图片
                con[serialNumber] = container;
                server_datail[relate] = container; //使当前机柜详情和机房机柜关联
                server_datail[relate].visible = false;
                container.serialNumber = serialNumber;
                container.type = type;
                container.relate = relate;
                scene.add(container);
                return container;
            }
            function AddNode(x, y, str, img, textPosition,serialNum,type,relate)//机房机柜
            {
                var node = new JTopo.Node(str);
                node.serializedProperties.push('type');
                node.serializedProperties.push('id');
                node.serializedProperties.push('relate');
                node.setLocation(x ,y);
                node.Image = '';
                node.shadow = true;
                node.showSelected = false;
                node.id = x*y;
                if(null != img) {
                    node.setImage('./img/' + img, true);
                    node.Image = img;
                }
                node.textPosition = textPosition;
                node.fontColor = '219,219,219';
                node.font = '8pt Georgia';
                node.zIndex = 10;
                node.addEventListener('mouseup',function(event){
                    handler(event,node);//将当前事件的node赋给currentNode并显示右键菜单
                });
                node.addEventListener('click', function(event){
                    endNode = node;
                    if(null != currentNode && currentNode != endNode && validation === true){
                        strr = "";
                        Addlink(currentNode, endNode, strr);
                        currentNode = null;
                        validation = false;//验证是否在当前节点上右键点击了添加节点
                    }
                });
                node.type = type;
                node.relate = relate;
                server[relate] = node;//使当前机柜和机柜详情关联
                scene.add(node);
                con[serialNum].add(node);
                return node;
            }
              function AddEquipment(str, img, textPosition,serialNum,type)//机柜内部设备
            {
                var node = new JTopo.Node(str);
                node.serializedProperties.push('type');
                node.Image = '';
                node.shadow = true;
                node.showSelected = false;
                node.setImage('./img/' + img, true);
                node.Image = img;
                node.textPosition = textPosition;
                node.fontColor = '100,100,100';
                node.font = '8pt Georgia';
                node.visible = true;
                node.zIndex = 20;
                scene.add(node);
                con[serialNum].add(node);
                node.visible = false;
                node.type = type;
                return node;
            }
            function Addlink(node1, node2, str, color)
            {
                var link = new JTopo.Link(node1, node2, str);
                //node2.father = node1;
                link.lineWidth = 3;//线宽
                link.bundleOffset = 60;
                link.bundleGap = 20;
                link.textOffsetY = 3;
                link.zIndex = 9;
                link.fontColor = color || '0, 200, 255';
                link.strokeColor = color || '0, 200, 255';
                link.addEventListener('mouseup',function(event){
                    currentLink = this;
                    handlelink(event);
                });
                scene.add(link);
            }

            function handler(event, obj) {//绑定节点右键菜单
                $("#linkmenu").hide();
                if (event.button == 2) {
                    currentNode = obj;
                    tmpx = event.pageX + 30;
                    tmpy = event.pageY + 30;
                    $("#contextmenu").css({
                        top: event.pageY,
                        left: event.pageX
                    }).show();
                    $("#contextmenu a").click(function(){
                        var text = $(this).text();
                          if (text == '添加连线'){
                            validation = true;//验证是否在当前节点上右键点击了添加节点
                 }
                 });
                }
            }

            function handlelink(event){//绑定连线右键菜单
                $("#contextmenu").hide();
                if(event.button == 2){
                    $("#linkmenu").css({
                        top:event.pageY,
                        left:event.pageX
                    }).show();
                }
            }
            //加判定
            // con[11].visible = true;
            //右键菜单处理
            $("#contextmenu a").click(function(){
                var text = $(this).text();
                var relate = currentNode.relate;
                var num = null;
                if("取消" == text){
                    $("#contextmenu").hide();
                }
                if(text == '监视'){
                    // var num = null;
                    // $.ajax({//局部加载机柜详情
                    //     typt:"GET",
                    //     url:"js/jsonst.json",
                    //     dataType:"json",
                    //     success:function(data){
                    //         data.forEach(function(a){

                    //             if(a.type == "B" && a.relate == relate){//关联
                    //                 console.log(relate);
                    //                 num = a.serialNumber;
                    //                 AddCabinet(a.x,a.y,a.text,a.serialNumber,a.type,a.relate);
                    //             }
                    //             if(a.type == "C" && num == a.serialNum){
                    //                 AddEquipment(a.text, a.Image, a.textPosition,a.serialNum,a.type);
                    //             }
                    //         });
             
                    //     }
                    // });
                    // 先加载完隐藏再显示
                    server_datail[relate].visible = true;
                    var a = server_datail[relate];
                    for(var e=0;e< a.childs.length;e++){
                        var f= a.childs[e];
                        f.visible = true;
                    }   
                }
                if(text == "完成"){
                    server_datail[relate].visible = false;
                    var b = server_datail[relate];
                    for(var g=0;g< b.childs.length;g++){
                        var h= b.childs[g];
                        h.visible = false;
                    }   
                }               

                if(text == '放大'){
                    currentNode.scaleX += 0.2;
                    currentNode.scaleY += 0.2;
                }else if(text == '缩小'){
                    currentNode.scaleX -= 0.2;
                    currentNode.scaleY -= 0.2;
                }
                $("#contextmenu").hide();
            });
            $("#linkmenu a").click(function(){
                var text = $(this).text();
                if("取消" == text){
                    $("#linkmenu").hide();
                }else if(text == '删除连线')
                {
                    scene.remove(currentLink);
                }
                $("#linkmenu").hide();
            });
            stage.add(scene);
            // 页面工具栏
            function showJTopoToobar(stage){
                var toobarDiv = $('<div class="jtopo_toolbar">').html(''
                    +'&nbsp;&nbsp;<input type="button" id="centerButton" value="居中显示"/>'
                    +'<input type="button" id="zoomOutButton" value=" 放 大 " />'
                    +'<input type="button" id="zoomInButton" value=" 缩 小 " />'
                    +'&nbsp;&nbsp;<input type="checkbox" id="zoomCheckbox"/><label for="zoomCheckbox">鼠标缩放</label>'
                    +'&nbsp;&nbsp;<input type = "button" id = "saveJsonStr" value = "保 存"/>'
                    +'&nbsp;&nbsp;<input type="button" id="exportButton" value="导出PNG">');
                    
                $('#content').prepend(toobarDiv);

                // 工具栏按钮处理
                $("input[name='modeRadio']").click(function(){          
                    stage.mode = $("input[name='modeRadio']:checked").val();
                });
                $('#centerButton').click(function(){
                    stage.centerAndZoom(); //缩放并居中显示
                });
                $('#zoomOutButton').click(function(){//放大
                    stage.zoomOut();
                });
                $('#zoomInButton').click(function(){//缩小
                    stage.zoomIn();
                });
                $('#exportButton').click(function(){//保存PNG
                    stage.saveImageInfo();
                });
                $('#zoomCheckbox').click(function(){
                    if($('#zoomCheckbox').attr('checked')){
                        stage.wheelZoom = 0.85; // 设置鼠标缩放比例
                    }else{
                        stage.wheelZoom = null; // 取消鼠标缩放比例
                    }
                });
                $("#saveJsonStr").click(function(){//保存*************
                    var a = scene;
                    var d="[";
                    for(var e=0;e< a.childs.length;e++){
                        var f= a.childs[e];
                        if(f.elementType == 'container'){
                            if(f.type == 'A'){//机房
                            var num = f.serialNumber;
                             d+="{";
                             d += "\"elementType\":"+ '"'+f.elementType+'"';
                             d += ",\"type\":"+ '"'+f.type+'"';
                             d += ",\"serialNumber\":"+ '"'+num+'"';
                             d += ",\"x\":"+ f.x;
                             d += ",\"y\":"+ f.x;
                             d += ",\"text\":"+ '"'+ f.text+ '"';
                             d += ",\"font\":"+ '"'+ f.font+ '"';
                             d+="},";
                             for(var c=0;c< f.childs.length;c++){
                                var g = f.childs[c];
                                g.id = g.x * g.y;
                                d +="{";
                                d += "\"serialNum\":"+ '"'+num+'"';
                                d += ",\"relate\":"+ '"'+g.relate+'"';
                                d += ",\"type\":"+ '"'+g.type+'"';
                                d += ",\"elementType\":"+ '"'+g.elementType+'"';
                                d += ",\"x\":"+ g.x;
                                d += ",\"y\":"+ g.y;
                                d += ",\"id\":"+ g.id;
                                d += ",\"Image\":"+ '"'+ g.Image+ '"';
                                d += ",\"text\":"+ '"'+ g.text+ '"';
                                d +=",\"textPosition\":"+ '"'+ g.textPosition+ '"';
                                d +="},";
                             }
                         }else if(f.type == 'B'){//机柜详情
                            var num1 = f.serialNumber;
                            d+="{";
                             d += "\"elementType\":"+ '"'+f.elementType+'"';
                             d += ",\"relate\":"+ '"'+f.relate+'"';
                             d += ",\"type\":"+ '"'+f.type+'"';
                             d += ",\"serialNumber\":"+ '"'+num1+'"';
                             d += ",\"x\":"+ f.x;
                             d += ",\"y\":"+ f.y;
                             d += ",\"text\":"+ '"'+ f.text+ '"';
                             d+="},";
                             for(var h=0;h< f.childs.length;h++){
                                var i = f.childs[h];
                                d +="{";
                                d += "\"serialNum\":"+ '"'+num1+'"';
                                d += ",\"type\":"+ '"'+i.type+'"';
                                d += ",\"elementType\":"+ '"'+i.elementType+'"';
                                d += ",\"Image\":"+ '"'+ i.Image+ '"';
                                d += ",\"text\":"+ '"'+ i.text+ '"';
                                d +=",\"textPosition\":"+ '"'+ i.textPosition+ '"';
                                d +="},";
                             }
                         }
                        }else if(f.elementType == 'link'){
                            d+="{";
                            d += "\"elementType\":"+ '"'+ f.elementType+ '"';
                            d += ",\"nodeAid\":"+ f.nodeA.id;
                            d += ",\"nodeZid\":"+ f.nodeZ.id;
                            d += ",\"text\":"+ '"'+ f.text+ '"';
                            d +=",\"fontColor\":"+ '"'+ f.fontColor+ '"';
                            d+="},";
                        }
                    }
                    d= d.substring(0, d.length-1);
                    d+="]";
                    d = d.replace("\r\n", "\\r\\n");
                    console.log(d);
                    alert("保存成功");
                });
                
            }
        });
    </script>
</body>
</html>